(function(){var e,t,i=this;e={changeIdAttribute:"data-cid",userIdAttribute:"data-userid",userNameAttribute:"data-username",timeAttribute:"data-time",attrValuePrefix:"",blockEl:"p",blockEls:["p","ol","ul","li","h1","h2","h3","h4","h5","h6","blockquote"],stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"span",alias:"ins",action:"Inserted"},deleteType:{tag:"span",alias:"del",action:"Deleted"},boldType:{tag:"b",alias:"bold",action:"Bolded"},italicType:{tag:"i",alias:"itc",action:"italicized"},underlineType:{tag:"u",alias:"uln",action:"Underlined"}},handleEvents:!1,contentEditable:!0,isTracking:!0,noTrack:".ice-no-track",avoid:".ice-avoid",mergeBlocks:!0},t=function(t){if(this._changes={},t||(t={}),!t.element)throw Error("`options.element` must be defined for ice construction.");ice.dom.extend(!0,this,e,t),this.pluginsManager=new ice.IcePluginManager(this),t.plugins&&this.pluginsManager.usePlugins("ice-init",t.plugins)},t.prototype={_userStyles:{},_styles:{},_uniqueStyleIndex:0,_browserType:null,_batchChangeid:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:!1,startTracking:function(){if(this.element.setAttribute("contentEditable",this.contentEditable),this.handleEvents){var e=this;ice.dom.bind(e.element,"keyup.ice keydown.ice keypress.ice mousedown.ice mouseup.ice",function(t){return e.handleEvent(t)})}return this.initializeEnvironment(),this.initializeEditor(),this.findTrackTags(),this.initializeRange(),this.pluginsManager.fireEnabled(this.element),this},stopTracking:function(){if(this.element.setAttribute("contentEditable",!this.contentEditable),this.handleEvents){var e=this;ice.dom.unbind(e.element,"keyup.ice keydown.ice keypress.ice mousedown.ice mouseup.ice")}return this.pluginsManager.fireDisabled(this.element),this},initializeEnvironment:function(){this.env||(this.env={}),this.env.element=this.element,this.env.document=this.element.ownerDocument,this.env.window=this.env.document.defaultView||this.env.document.parentWindow||window,this.env.frame=this.env.window.frameElement,this.env.selection=this.selection=new ice.Selection(this.env),this.env.document.createElement(this.changeTypes.insertType.tag),this.env.document.createElement(this.changeTypes.deleteType.tag),this.env.document.createElement(this.changeTypes.boldType.tag),this.env.document.createElement(this.changeTypes.italicType.tag),this.env.document.createElement(this.changeTypes.underlineType.tag)},initializeRange:function(){var e=this.selection.createRange();e.setStart(ice.dom.find(this.element,this.blockEls.join(", "))[0],0),e.collapse(!0),this.selection.addRange(e),this.env.frame?this.env.frame.contentWindow.focus():this.element.focus()},initializeEditor:function(){var e=this.env.document.createElement("div");this.element.childNodes.length?(e.innerHTML=this.element.innerHTML,ice.dom.removeWhitespace(e),""===e.innerHTML&&e.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+">"))):e.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+">")),this.element.innerHTML!=e.innerHTML&&(this.element.innerHTML=e.innerHTML)},findTrackTags:function(){var e=this,t=[];for(var i in this.changeTypes)t.push(this._getIceNodeClass(i));ice.dom.each(ice.dom.find(this.element,"."+t.join(", .")),function(i,n){for(var o=0,r="",s=n.className.split(" "),i=0;i<s.length;i++){var a=new RegExp(e.stylePrefix+"-(\\d+)").exec(s[i]);a&&(o=a[1]);var d=new RegExp("("+t.join("|")+")").exec(s[i]);d&&(r=e._getChangeTypeFromAlias(d[1]))}var l=ice.dom.attr(n,e.userIdAttribute);e.setUserStyle(l,Number(o));var c=ice.dom.attr(n,e.changeIdAttribute);e._changes[c]={type:r,userid:l,username:ice.dom.attr(n,e.userNameAttribute),time:ice.dom.attr(n,e.timeAttribute)}})},enableChangeTracking:function(){this.isTracking=!0,this.pluginsManager.fireEnabled(this.element)},disableChangeTracking:function(){this.isTracking=!1,this.pluginsManager.fireDisabled(this.element)},setCurrentUser:function(e){this.currentUser=e},handleEvent:function(e){if(this.isTracking)if("mouseup"==e.type){var t=this;setTimeout(function(){t.mouseUp(e)},200)}else{if("mousedown"==e.type)return this.mouseDown(e);if("keypress"==e.type){var i=this.keyPress(e);return i||e.preventDefault(),i}if("keydown"==e.type){var i=this.keyDown(e);return i||e.preventDefault(),i}"keyup"==e.type&&this.pluginsManager.fireCaretUpdated()}},visible:function(e){e.nodeType===ice.dom.TEXT_NODE&&(e=e.parentNode);var t=e.getBoundingClientRect();return t.top>0&&t.left>0},createIceNode:function(e,t){var i=this.env.document.createElement(this.changeTypes[e].tag);return ice.dom.addClass(i,this._getIceNodeClass(e)),i.appendChild(t?t:this.env.document.createTextNode("")),this.addChange(this.changeTypes[e].alias,[i]),this.pluginsManager.fireNodeCreated(i,{action:this.changeTypes[e].action}),i},insertBold:function(e,t){var i=!0;ice.dom.browser();t?this.selection.addRange(t):t=this.getCurrentRange();var n=this.startBatchChange(this.changeTypes.boldType.alias);if(t.collapsed===!1){for(var o=new ice.Bookmark(this.env,t),r=ice.dom.getElementsBetween(o.start,o.end),s=ice.dom.parents(t.startContainer,this.blockEls.join(", "))[0],a=ice.dom.parents(t.endContainer,this.blockEls.join(", "))[0],d=new Array,l=0;l<r.length;l++){var c=r[l];if(!ice.dom.isBlockElement(c)||(d.push(c),ice.dom.canContainTextElement(c))){if((c.nodeType!==ice.dom.TEXT_NODE||0!==ice.dom.getNodeTextContent(c).length)&&!this._getVoidElement(c)){var h=ice.dom.getBlockParent(c);this._addNodeBoldTracking(c,t,!0,!0),ice.dom.hasNoTextOrStubContent(h)&&ice.dom.remove(h)}}else for(var m=0;m<c.childNodes.length;m++)r.push(c.childNodes[m])}if(this.mergeBlocks&&s!==a){for(;d.length;)ice.dom.mergeContainers(d.shift(),s);ice.dom.removeBRFromChild(a),ice.dom.removeBRFromChild(s),ice.dom.mergeContainers(a,s)}o.selectBookmark(),t.collapse(!0)}return this.selection.addRange(t),this.endBatchChange(n),i},_addNodeBoldTracking:function(e,t,i){e.previousSibling&&e.previousSibling.nodeType===ice.dom.TEXT_NODE&&0===e.previousSibling.length&&e.parentNode.removeChild(e.previousSibling),e.nextSibling&&e.nextSibling.nodeType===ice.dom.TEXT_NODE&&0===e.nextSibling.length&&e.parentNode.removeChild(e.nextSibling);var n,o=this.getIceNode(e.previousSibling,"boldType"),r=this.getIceNode(e.nextSibling,"boldType");if(o&&this._currentUserIceNode(o)){if(n=o,n.appendChild(e),r&&this._currentUserIceNode(r)){var s=ice.dom.extractContent(r);ice.dom.append(n,s),r.parentNode.removeChild(r)}}else r&&this._currentUserIceNode(r)?(n=r,n.insertBefore(e,n.firstChild)):(n=this.createIceNode("boldType"),e.parentNode.insertBefore(n,e),n.appendChild(e));return t&&(ice.dom.isStubElement(e)?t.selectNode(e):t.selectNodeContents(e),i?t.collapse(!0):t.collapse(),e.normalize()),!0},insertItalic:function(e,t){var i=!0;ice.dom.browser();t?this.selection.addRange(t):t=this.getCurrentRange();var n=this.startBatchChange(this.changeTypes.italicType.alias);if(t.collapsed===!1){for(var o=new ice.Bookmark(this.env,t),r=ice.dom.getElementsBetween(o.start,o.end),s=ice.dom.parents(t.startContainer,this.blockEls.join(", "))[0],a=ice.dom.parents(t.endContainer,this.blockEls.join(", "))[0],d=new Array,l=0;l<r.length;l++){var c=r[l];if(console.log(JSON.parse(JSON.stringify(ice.dom.isBlockElement(c)))),!ice.dom.isBlockElement(c)||(d.push(c),ice.dom.canContainTextElement(c))){if((c.nodeType!==ice.dom.TEXT_NODE||0!==ice.dom.getNodeTextContent(c).length)&&!this._getVoidElement(c)){var h=ice.dom.getBlockParent(c);this._addNodeItalicTracking(c,!1,!0,!0),ice.dom.hasNoTextOrStubContent(h)&&ice.dom.remove(h)}}else for(var m=0;m<c.childNodes.length;m++)r.push(c.childNodes[m])}if(this.mergeBlocks&&s!==a){for(;d.length;)ice.dom.mergeContainers(d.shift(),s);ice.dom.removeBRFromChild(a),ice.dom.removeBRFromChild(s),ice.dom.mergeContainers(a,s)}o.selectBookmark(),t.collapse(!0)}return this.selection.addRange(t),this.endBatchChange(n),i},_addNodeItalicTracking:function(e,t,i){e.previousSibling&&e.previousSibling.nodeType===ice.dom.TEXT_NODE&&0===e.previousSibling.length&&e.parentNode.removeChild(e.previousSibling),e.nextSibling&&e.nextSibling.nodeType===ice.dom.TEXT_NODE&&0===e.nextSibling.length&&e.parentNode.removeChild(e.nextSibling);var n,o=this.getIceNode(e.previousSibling,"italicType"),r=this.getIceNode(e.nextSibling,"italicType");if(o&&this._currentUserIceNode(o)){if(n=o,n.appendChild(e),r&&this._currentUserIceNode(r)){var s=ice.dom.extractContent(r);ice.dom.append(n,s),r.parentNode.removeChild(r)}}else r&&this._currentUserIceNode(r)?(n=r,n.insertBefore(e,n.firstChild)):(n=this.createIceNode("italicType"),e.parentNode.insertBefore(n,e),n.appendChild(e));return t&&(ice.dom.isStubElement(e)?t.selectNode(e):t.selectNodeContents(e),i?t.collapse(!0):t.collapse(),e.normalize()),!0},insertUnderline:function(e,t){var i=!0;ice.dom.browser();t?this.selection.addRange(t):t=this.getCurrentRange();var n=this.startBatchChange(this.changeTypes.underlineType.alias);if(t.collapsed===!1){for(var o=new ice.Bookmark(this.env,t),r=ice.dom.getElementsBetween(o.start,o.end),s=ice.dom.parents(t.startContainer,this.blockEls.join(", "))[0],a=ice.dom.parents(t.endContainer,this.blockEls.join(", "))[0],d=new Array,l=0;l<r.length;l++){var c=r[l];if(console.log(JSON.parse(JSON.stringify(ice.dom.isBlockElement(c)))),!ice.dom.isBlockElement(c)||(d.push(c),ice.dom.canContainTextElement(c))){if((c.nodeType!==ice.dom.TEXT_NODE||0!==ice.dom.getNodeTextContent(c).length)&&!this._getVoidElement(c)){var h=ice.dom.getBlockParent(c);this._addNodeUnderlineTracking(c,!1,!0,!0),ice.dom.hasNoTextOrStubContent(h)&&ice.dom.remove(h)}}else for(var m=0;m<c.childNodes.length;m++)r.push(c.childNodes[m])}if(this.mergeBlocks&&s!==a){for(;d.length;)ice.dom.mergeContainers(d.shift(),s);ice.dom.removeBRFromChild(a),ice.dom.removeBRFromChild(s),ice.dom.mergeContainers(a,s)}o.selectBookmark(),t.collapse(!0)}return this.selection.addRange(t),this.endBatchChange(n),i},_addNodeUnderlineTracking:function(e,t,i){e.previousSibling&&e.previousSibling.nodeType===ice.dom.TEXT_NODE&&0===e.previousSibling.length&&e.parentNode.removeChild(e.previousSibling),e.nextSibling&&e.nextSibling.nodeType===ice.dom.TEXT_NODE&&0===e.nextSibling.length&&e.parentNode.removeChild(e.nextSibling);var n,o=this.getIceNode(e.previousSibling,"underlineType"),r=this.getIceNode(e.nextSibling,"underlineType");if(o&&this._currentUserIceNode(o)){if(n=o,n.appendChild(e),r&&this._currentUserIceNode(r)){var s=ice.dom.extractContent(r);ice.dom.append(n,s),r.parentNode.removeChild(r)}}else r&&this._currentUserIceNode(r)?(n=r,n.insertBefore(e,n.firstChild)):(n=this.createIceNode("underlineType"),e.parentNode.insertBefore(n,e),n.appendChild(e));return t&&(ice.dom.isStubElement(e)?t.selectNode(e):t.selectNodeContents(e),i?t.collapse(!0):t.collapse(),e.normalize()),!0},insert:function(e,t){var i=!e;if(e||(e="\ufeff"),t?this.selection.addRange(t):t=this.getCurrentRange(),"string"==typeof e&&(e=document.createTextNode(e)),!t.collapsed&&(t=this.getCurrentRange(),t.startContainer===t.endContainer&&this.element===t.startContainer)){ice.dom.empty(this.element);var n=t.getLastSelectableChild(this.element);t.setStartAfter(n),t.collapse(!0)}this._moveRangeToValidTrackingPos(t);var o=this.startBatchChange();return this._insertNode(e,t,i),this.pluginsManager.fireNodeInserted(e,t),this.endBatchChange(o),i},placeholdDeletes:function(){var e=this;this.isPlaceholdingDeletes&&this.revertDeletePlaceholders(),this.isPlaceholdingDeletes=!0,this._deletes=[];var t="."+this._getIceNodeClass("deleteType");return ice.dom.each(ice.dom.find(this.element,t),function(t,i){e._deletes.push(ice.dom.cloneNode(i)),ice.dom.replaceWith(i,"<"+e._delBookmark+' data-allocation="'+(e._deletes.length-1)+'"/>')}),!0},revertDeletePlaceholders:function(){var e=this;return this.isPlaceholdingDeletes?(ice.dom.each(this._deletes,function(t,i){ice.dom.find(e.element,e._delBookmark+"[data-allocation="+t+"]").replaceWith(i)}),this.isPlaceholdingDeletes=!1,!0):!1},deleteContents:function(e,t){var i=!0,n=ice.dom.browser();t?this.selection.addRange(t):t=this.getCurrentRange();var o=this.startBatchChange(this.changeTypes.deleteType.alias);if(t.collapsed===!1)this._currentUserIceNode(t.startContainer.parentNode)?this._deleteSelection(t):(this._deleteSelection(t),"mozilla"===n.type?(t.startContainer.parentNode.previousSibling?(t.setEnd(t.startContainer.parentNode.previousSibling,0),t.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(t.endContainer))):t.setEndAfter(t.startContainer.parentNode),t.collapse(!1)):this.visible(t.endContainer)||(t.setEnd(t.endContainer,t.endOffset-1),t.collapse(!1)));else if(e)if("mozilla"===n.type)i=this._deleteRight(t),this.visible(t.endContainer)||(t.endContainer.parentNode.nextSibling?t.setEndBefore(t.endContainer.parentNode.nextSibling):t.setEndAfter(t.endContainer),t.collapse(!1));else{if(t.endOffset===ice.dom.getNodeCharacterLength(t.endContainer)){var r=t.startContainer.nextSibling;if(ice.dom.is(r,"."+this._getIceNodeClass("deleteType")))for(;r;){if(!ice.dom.is(r,"."+this._getIceNodeClass("deleteType"))){t.setStart(r,0),t.collapse(!0);break}r=r.nextSibling}}i=this._deleteRight(t),this.visible(t.endContainer)||ice.dom.is(t.endContainer.parentNode,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&(t.setStartAfter(t.endContainer.parentNode),t.collapse(!0))}else if("mozilla"===n.type)i=this._deleteLeft(t),this.visible(t.startContainer)||(t.startContainer.parentNode.previousSibling?t.setEnd(t.startContainer.parentNode.previousSibling,0):t.setEnd(t.startContainer.parentNode,0),t.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(t.endContainer)),t.collapse(!1));else{if(!this.visible(t.startContainer)&&t.endOffset===ice.dom.getNodeCharacterLength(t.endContainer)){var s=t.startContainer.previousSibling;if(ice.dom.is(s,"."+this._getIceNodeClass("deleteType")))for(;s;){if(!ice.dom.is(s,"."+this._getIceNodeClass("deleteType"))){t.setEndBefore(s.nextSibling,0),t.collapse(!1);break}s=s.prevSibling}}i=this._deleteLeft(t)}return this.selection.addRange(t),this.endBatchChange(o),i},getChanges:function(){return this._changes},getChangeUserids:function(){var e=[],t=Object.keys(this._changes);for(var i in t)e.push(this._changes[t[i]].userid);return e.sort().filter(function(e,t,i){return t==i.indexOf(e)?1:0})},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(e,t,i){var n="",o=this;ice.dom.each(this.changeTypes,function(e,t){"deleteType"!=e&&(t>0&&(n+=","),n+="."+o._getIceNodeClass(e))}),e=e?"string"==typeof e?ice.dom.create("<div>"+e+"</div>"):ice.dom.cloneNode(e,!1)[0]:ice.dom.cloneNode(this.element,!1)[0],e=i?i.call(this,e):e;var r=ice.dom.find(e,n);ice.dom.each(r,function(e,t){ice.dom.replaceWith(this,ice.dom.contents(this))});var s=ice.dom.find(e,"."+this._getIceNodeClass("deleteType"));return ice.dom.remove(s),e=t?t.call(this,e):e,e.innerHTML},acceptAll:function(){this.element.innerHTML=this.getCleanContent()},rejectAll:function(){var e="."+this._getIceNodeClass("insertType"),t="."+this._getIceNodeClass("deleteType"),i="."+this._getIceNodeClass("boldType"),n="."+this._getIceNodeClass("italicType"),o="."+this._getIceNodeClass("underlineType");ice.dom.remove(ice.dom.find(this.element,e)),ice.dom.each(ice.dom.find(this.element,t),function(e,t){ice.dom.replaceWith(t,ice.dom.contents(t))}),ice.dom.each(ice.dom.find(this.element,i),function(e,t){ice.dom.replaceWith(t,ice.dom.contents(t))}),ice.dom.remove(ice.dom.find(this.element,n)),ice.dom.remove(ice.dom.find(this.element,o))},acceptChange:function(e){this.acceptRejectChange(e,!0)},rejectChange:function(e){this.acceptRejectChange(e,!1)},acceptRejectChange:function(e,t){var i,n,o,r,s,a,d,l,c,h,m=ice.dom;if(!e){var g=this.getCurrentRange();if(!g.collapsed)return;e=g.startContainer}i=d="."+this._getIceNodeClass("deleteType"),n=l="."+this._getIceNodeClass("insertType"),o=l="."+this._getIceNodeClass("boldType"),r=l="."+this._getIceNodeClass("italicType"),s=l="."+this._getIceNodeClass("underlineType"),a=i+","+n+","+o+","+r+","+s,c=m.getNode(e,a),h=m.find(this.element,"["+this.changeIdAttribute+"="+m.attr(c,this.changeIdAttribute)+"]"),t||(d=n,l=i,l=o),ice.dom.is(c,l)?m.each(h,function(e,t){m.replaceWith(t,ice.dom.contents(t))}):m.is(c,d)&&m.remove(h)},isInsideChange:function(e){var t="."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType");if(!e){if(range=this.getCurrentRange(),!range.collapsed)return!1;e=range.startContainer}return!!ice.dom.getNode(e,t)},addChangeType:function(e,t,i,n){var o={tag:t,alias:i};n&&(o.action=n),this.changeTypes[e]=o},getIceNode:function(e,t){var i="."+this._getIceNodeClass(t);return ice.dom.getNode(e,i)},_moveRangeToValidTrackingPos:function(e){for(var t=!1,i=this._getVoidElement(e.endContainer);i;){try{e.moveEnd(ice.dom.CHARACTER_UNIT,1),e.moveEnd(ice.dom.CHARACTER_UNIT,-1)}catch(n){t=!0}if(t||ice.dom.onBlockBoundary(e.endContainer,e.startContainer,this.blockEls)){e.setStartAfter(i),e.collapse(!0);break}i=this._getVoidElement(e.endContainer),i?(e.setEnd(e.endContainer,0),e.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(e.endContainer)),e.collapse()):(e.setStart(e.endContainer,0),e.collapse(!0))}},_getNoTrackElement:function(e){var t=this._getNoTrackSelector(),i=ice.dom.is(e,t)?e:ice.dom.parents(e,t)[0]||null;return i},_getNoTrackSelector:function(){return this.noTrack},_getVoidElement:function(e){var t=this._getVoidElSelector();return ice.dom.is(e,t)?e:ice.dom.parents(e,t)[0]||null},_getVoidElSelector:function(){return"."+this._getIceNodeClass("deleteType")+","+this.avoid},_currentUserIceNode:function(e){return ice.dom.attr(e,this.userIdAttribute)==this.currentUser.id},_getChangeTypeFromAlias:function(e){var t,i=null;for(t in this.changeTypes)this.changeTypes.hasOwnProperty(t)&&this.changeTypes[t].alias==e&&(i=t);return i},_getIceNodeClass:function(e){return this.attrValuePrefix+this.changeTypes[e].alias},getUserStyle:function(e){var t=null;return t=this._userStyles[e]?this._userStyles[e]:this.setUserStyle(e,this.getNewStyleId())},setUserStyle:function(e,t){var i=this.stylePrefix+"-"+t;return this._styles[t]||(this._styles[t]=!0),this._userStyles[e]=i},getNewStyleId:function(){var e=++this._uniqueStyleIndex;return this._styles[e]?this.getNewStyleId():(this._styles[e]=!0,e)},addChange:function(e,t){var i=this._batchChangeid||this.getNewChangeId();this._changes[i]||(this._changes[i]={type:this._getChangeTypeFromAlias(e),time:(new Date).getTime(),userid:this.currentUser.id,username:this.currentUser.name});var n=this;return ice.dom.foreach(t,function(e){n.addNodeToChange(i,t[e])}),i},addNodeToChange:function(e,t){null!==this._batchChangeid&&(e=this._batchChangeid);var i=this.getChange(e);t.getAttribute(this.changeIdAttribute)||t.setAttribute(this.changeIdAttribute,e),t.getAttribute(this.userIdAttribute)||t.setAttribute(this.userIdAttribute,i.userid),t.getAttribute(this.userNameAttribute)||t.setAttribute(this.userNameAttribute,i.username),t.getAttribute(this.timeAttribute)||t.setAttribute(this.timeAttribute,i.time),ice.dom.hasClass(t,this._getIceNodeClass(i.type))||ice.dom.addClass(t,this._getIceNodeClass(i.type));var n=this.getUserStyle(i.userid);ice.dom.hasClass(t,n)||ice.dom.addClass(t,n)},getChange:function(e){var t=null;return this._changes[e]&&(t=this._changes[e]),t},getNewChangeId:function(){var e=++this._uniqueIDIndex;return this._changes[e]&&(e=this.getNewChangeId()),e},startBatchChange:function(){return this._batchChangeid=this.getNewChangeId(),this._batchChangeid},endBatchChange:function(e){e===this._batchChangeid&&(this._batchChangeid=null)},getCurrentRange:function(){return this.selection.getRangeAt(0)},_insertNode:function(e,t,i){ice.dom.isBlockElement(t.startContainer)||ice.dom.canContainTextElement(ice.dom.getBlockParent(t.startContainer,this.element))||!t.startContainer.previousSibling||t.setStart(t.startContainer.previousSibling,0);var n=(t.startContainer,ice.dom.isBlockElement(t.startContainer)&&t.startContainer||ice.dom.getBlockParent(t.startContainer,this.element)||null);if(n===this.element){var o=document.createElement(this.blockEl);return n.appendChild(o),t.setStart(o,0),t.collapse(),this._insertNode(e,t,i)}ice.dom.hasNoTextOrStubContent(n)&&(ice.dom.empty(n),ice.dom.append(n,"<br>"),t.setStart(n,0));var r=this.getIceNode(t.startContainer,"insertType"),s=this._currentUserIceNode(r);i&&s||(s||(e=this.createIceNode("insertType",e)),t.insertNode(e),t.setEnd(e,1),i?t.setStart(e,0):t.collapse(),this.selection.addRange(t))},_handleVoidEl:function(e,t){var i=this._getVoidElement(e);return i&&!this.getIceNode(i,"deleteType")?(t.collapse(!0),!0):!1},_deleteSelection:function(e){for(var t=new ice.Bookmark(this.env,e),i=ice.dom.getElementsBetween(t.start,t.end),n=ice.dom.parents(e.startContainer,this.blockEls.join(", "))[0],o=ice.dom.parents(e.endContainer,this.blockEls.join(", "))[0],r=new Array,s=0;s<i.length;s++){var a=i[s];if(!ice.dom.isBlockElement(a)||(r.push(a),ice.dom.canContainTextElement(a))){if((a.nodeType!==ice.dom.TEXT_NODE||0!==ice.dom.getNodeTextContent(a).length)&&!this._getVoidElement(a)){if(a.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(a))continue;if(ice.dom.isStubElement(a)){this._addNodeTracking(a,!1,!0);continue}for(ice.dom.hasNoTextOrStubContent(a)&&ice.dom.remove(a),j=0;j<a.childNodes.length;j++){var d=a.childNodes[j];i.push(d)}continue}var l=ice.dom.getBlockParent(a);this._addNodeTracking(a,!1,!0,!0),ice.dom.hasNoTextOrStubContent(l)&&ice.dom.remove(l)}}else for(var c=0;c<a.childNodes.length;c++)i.push(a.childNodes[c])}if(this.mergeBlocks&&n!==o){for(;r.length;)ice.dom.mergeContainers(r.shift(),n);ice.dom.removeBRFromChild(o),ice.dom.removeBRFromChild(n),ice.dom.mergeContainers(o,n)}t.selectBookmark(),e.collapse(!0)},_deleteRight:function(e){var t,i,n=ice.dom.isBlockElement(e.startContainer)&&e.startContainer||ice.dom.getBlockParent(e.startContainer,this.element)||null,o=n?ice.dom.hasNoTextOrStubContent(n):!1,r=n&&ice.dom.getNextContentNode(n,this.element),s=r?ice.dom.hasNoTextOrStubContent(r):!1,a=e.endContainer,d=e.endOffset,l=e.commonAncestorContainer;if(o)return!1;if(l.nodeType!==ice.dom.TEXT_NODE){if(0===d&&ice.dom.isBlockElement(l)&&!ice.dom.canContainTextElement(l)){var c=l.firstElementChild;if(c)return e.setStart(c,0),e.collapse(),this._deleteRight(e)}if(l.childNodes.length>d){var h=document.createTextNode(" ");return l.insertBefore(h,l.childNodes[d]),e.setStart(h,1),e.collapse(!0),i=this._deleteRight(e),ice.dom.remove(h),i}return t=ice.dom.getNextContentNode(l,this.element),e.setEnd(t,0),e.collapse(),this._deleteRight(e)}if(e.moveEnd(ice.dom.CHARACTER_UNIT,1),e.moveEnd(ice.dom.CHARACTER_UNIT,-1),d===a.data.length&&!ice.dom.hasNoTextOrStubContent(a)){if(t=ice.dom.getNextNode(a,this.element),!t)return e.selectNodeContents(a),e.collapse(),!1;if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(t)&&(t=ice.dom.getNextNode(t,this.element)),t.nodeType===ice.dom.TEXT_NODE&&(t=t.parentNode),!t.isContentEditable){i=this._addNodeTracking(t,!1,!1);var m=document.createTextNode("");return t.parentNode.insertBefore(m,t.nextSibling),e.selectNode(m),e.collapse(!0),i}if(this._handleVoidEl(t,e))return!0;if(ice.dom.isChildOf(t,n)&&ice.dom.isStubElement(t))return this._addNodeTracking(t,e,!1)}if(this._handleVoidEl(t,e))return!0;if(this._getNoTrackElement(e.endContainer.parentElement))return e.deleteContents(),!1;if(ice.dom.isOnBlockBoundary(e.startContainer,e.endContainer,this.element)){if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(t,this.element),this.blockEl)){r!==ice.dom.getBlockParent(e.endContainer,this.element)&&e.setEnd(r,0);for(var g=ice.dom.getElementsBetween(e.startContainer,e.endContainer),u=0;u<g.length;u++)ice.dom.remove(g[u]);var p=e.startContainer,C=e.endContainer;return ice.dom.remove(ice.dom.find(p,"br")),ice.dom.remove(ice.dom.find(C,"br")),ice.dom.mergeBlockWithSibling(e,ice.dom.getBlockParent(e.endContainer,this.element)||n)}return s?(ice.dom.remove(r),e.collapse(!0),!0):(e.setStart(r,0),e.collapse(!0),!0)}var f=e.endContainer,v=f.splitText(e.endOffset);v.splitText(1);return this._addNodeTracking(v,e,!1)},_deleteLeft:function(e){var t,i,n=ice.dom.isBlockElement(e.startContainer)&&e.startContainer||ice.dom.getBlockParent(e.startContainer,this.element)||null,o=n?ice.dom.hasNoTextOrStubContent(n):!1,r=n&&ice.dom.getPrevContentNode(n,this.element),s=r?ice.dom.hasNoTextOrStubContent(r):!1,a=e.startContainer,d=e.startOffset,l=e.commonAncestorContainer;if(o)return!1;if(0===d||l.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isBlockElement(l)&&!ice.dom.canContainTextElement(l))if(0===d){var c=l.firstElementChild;if(c)return e.setStart(c,0),e.collapse(),this._deleteLeft(e)}else{var h=l.lastElementChild;if(h&&(t=e.getLastSelectableChild(h)))return e.setStart(t,t.data.length),e.collapse(),this._deleteLeft(e)}if(0===d)i=ice.dom.getPrevContentNode(a,this.element);else{i=l.childNodes[d-1]}if(!i)return!1;if(ice.dom.is(i,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&i.childNodes.length>0&&i.lastChild&&(i=i.lastChild),i.nodeType===ice.dom.TEXT_NODE&&(i=i.parentNode),!i.isContentEditable){var m=this._addNodeTracking(i,!1,!0),g=document.createTextNode("");return i.parentNode.insertBefore(g,i),e.selectNode(g),e.collapse(!0),m}if(this._handleVoidEl(i,e))return!0;if(ice.dom.isStubElement(i)&&ice.dom.isChildOf(i,n)||!i.isContentEditable)return this._addNodeTracking(i,e,!0);if(ice.dom.isStubElement(i))return ice.dom.remove(i),e.collapse(!0),!1;if(i!==n&&!ice.dom.isChildOf(i,n)){if(ice.dom.canContainTextElement(i)||(i=i.lastElementChild),i.lastChild&&i.lastChild.nodeType!==ice.dom.TEXT_NODE&&ice.dom.isStubElement(i.lastChild)&&"BR"!==i.lastChild.tagName)return e.setStartAfter(i.lastChild),e.collapse(!0),!0;if(t=e.getLastSelectableChild(i),t&&!ice.dom.isOnBlockBoundary(e.startContainer,t,this.element))return e.selectNodeContents(t),e.collapse(),!0}}if(1===d&&!ice.dom.isBlockElement(l)&&e.startContainer.childNodes.length>1&&e.startContainer.childNodes[0].nodeType===ice.dom.TEXT_NODE&&0===e.startContainer.childNodes[0].data.length)return e.setStart(e.startContainer,0),this._deleteLeft(e);if(e.moveStart(ice.dom.CHARACTER_UNIT,-1),e.moveStart(ice.dom.CHARACTER_UNIT,1),this._getNoTrackElement(e.startContainer.parentElement))return e.deleteContents(),!1;if(ice.dom.isOnBlockBoundary(e.startContainer,e.endContainer,this.element)){if(s)return ice.dom.remove(r),e.collapse(),!0;if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(i,this.element),this.blockEl)){r!==ice.dom.getBlockParent(e.startContainer,this.element)&&e.setStart(r,r.childNodes.length);for(var u=ice.dom.getElementsBetween(e.startContainer,e.endContainer),p=0;p<u.length;p++)ice.dom.remove(u[p]);var C=e.startContainer,f=e.endContainer;return ice.dom.remove(ice.dom.find(C,"br")),ice.dom.remove(ice.dom.find(f,"br")),ice.dom.mergeBlockWithSibling(e,ice.dom.getBlockParent(e.endContainer,this.element)||n)}return r&&r.lastChild&&ice.dom.isStubElement(r.lastChild)?(e.setStartAfter(r.lastChild),e.collapse(!0),!0):(t=e.getLastSelectableChild(r),t?(e.setStart(t,t.data.length),e.collapse(!0)):r&&(e.setStart(r,r.childNodes.length),e.collapse(!0)),!0)}var v=e.startContainer,N=v.splitText(e.startOffset-1);N.splitText(1);return this._addNodeTracking(N,e,!0)},_addNodeTracking:function(e,t,i){var n=this.getIceNode(e,"insertType");if(n&&this._currentUserIceNode(n)){t&&i&&t.selectNode(e),e.parentNode.removeChild(e);var o=ice.dom.cloneNode(n);if(ice.dom.remove(ice.dom.find(o,".iceBookmark")),null!==n&&ice.dom.hasNoTextOrStubContent(o[0])){var r=this.env.document.createTextNode("");ice.dom.insertBefore(n,r),t&&(t.setStart(r,0),t.collapse(!0)),ice.dom.replaceWith(n,ice.dom.contents(n))}return!0}if(t&&this.getIceNode(e,"deleteType")){e.normalize();var s=!1;if(i){for(var a=ice.dom.getPrevContentNode(e,this.element);!s;)c=this.getIceNode(a,"deleteType"),c?a=ice.dom.getPrevContentNode(a,this.element):s=!0;if(a){var d=t.getLastSelectableChild(a);d&&(a=d),t.setStart(a,ice.dom.getNodeCharacterLength(a)),t.collapse(!0)}return!0}for(var l=ice.dom.getNextContentNode(e,this.element);!s;)c=this.getIceNode(l,"deleteType"),c?l=ice.dom.getNextContentNode(l,this.element):s=!0;return l&&(t.selectNodeContents(l),t.collapse(!0)),!0}e.previousSibling&&e.previousSibling.nodeType===ice.dom.TEXT_NODE&&0===e.previousSibling.length&&e.parentNode.removeChild(e.previousSibling),e.nextSibling&&e.nextSibling.nodeType===ice.dom.TEXT_NODE&&0===e.nextSibling.length&&e.parentNode.removeChild(e.nextSibling);var c,h=this.getIceNode(e.previousSibling,"deleteType"),m=this.getIceNode(e.nextSibling,"deleteType");if(h&&this._currentUserIceNode(h)){if(c=h,c.appendChild(e),m&&this._currentUserIceNode(m)){var g=ice.dom.extractContent(m);ice.dom.append(c,g),m.parentNode.removeChild(m)}}else m&&this._currentUserIceNode(m)?(c=m,c.insertBefore(e,c.firstChild)):(c=this.createIceNode("deleteType"),e.parentNode.insertBefore(c,e),c.appendChild(e));return t&&(ice.dom.isStubElement(e)?t.selectNode(e):t.selectNodeContents(e),i?t.collapse(!0):t.collapse(),e.normalize()),!0},_handleAncillaryKey:function(e){var t=e.keyCode?e.keyCode:e.which,i=ice.dom.browser(),n=!0,o=(e.shiftKey,this),r=o.getCurrentRange();switch(t){case ice.dom.DOM_VK_DELETE:n=this.deleteContents(),this.pluginsManager.fireKeyPressed(e);break;case 46:n=this.deleteContents(!0),this.pluginsManager.fireKeyPressed(e);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:this.pluginsManager.fireCaretPositioned(),"mozilla"===i.type&&(this.visible(r.startContainer)||(r.startContainer.parentNode.previousSibling?(r.setEnd(r.startContainer.parentNode.previousSibling,0),r.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(r.endContainer)),r.collapse(!1)):(r.setEnd(r.startContainer.parentNode.nextSibling,0),r.collapse(!1)))),n=!1;break;case ice.dom.DOM_VK_RIGHT:this.pluginsManager.fireCaretPositioned(),"mozilla"===i.type&&(this.visible(r.startContainer)||r.startContainer.parentNode.nextSibling&&(r.setStart(r.startContainer.parentNode.nextSibling,0),r.collapse(!0))),n=!1;break;case 32:n=!0;var r=this.getCurrentRange();this._moveRangeToValidTrackingPos(r,r.startContainer),this.insert(" ",r);break;default:n=!1}return n===!0?(ice.dom.preventDefault(e),!1):!0},keyDown:function(e){if(!this.pluginsManager.fireKeyDown(e))return ice.dom.preventDefault(e),!1;var t=!1;if(this._handleSpecialKey(e)===!1)return ice.dom.isBrowser("msie")!==!0&&(this._preventKeyPress=!0),!1;if(!(e.ctrlKey!==!0&&e.metaKey!==!0||ice.dom.isBrowser("msie")!==!0&&ice.dom.isBrowser("chrome")!==!0||this.pluginsManager.fireKeyPressed(e)))return!1;switch(e.keyCode){case 27:break;default:/Firefox/.test(navigator.userAgent)!==!0&&(t=!this._handleAncillaryKey(e))}return t?(ice.dom.preventDefault(e),!1):!0},keyPress:function(e){if(this._preventKeyPress===!0)return void(this._preventKeyPress=!1);if(!this.pluginsManager.fireKeyPress(e))return!1;var t=null;null==e.which?t=String.fromCharCode(e.keyCode):e.which>0&&(t=String.fromCharCode(e.which));var i=this.getCurrentRange(),n=ice.dom.parents(i.startContainer,"br")[0]||null;if(n&&(i.moveToNextEl(n),n.parentNode.removeChild(n)),null!==t&&e.ctrlKey!==!0&&e.metaKey!==!0){var o=e.keyCode?e.keyCode:e.which;switch(o){case ice.dom.DOM_VK_DELETE:return this._handleAncillaryKey(e);case ice.dom.DOM_VK_ENTER:return this._handleEnter();case 32:return this._handleAncillaryKey(e);default:return this._moveRangeToValidTrackingPos(i,i.startContainer),this.insert()}}return this._handleAncillaryKey(e)},_handleEnter:function(){var e=this.getCurrentRange();return e.collapsed||this.deleteContents(),!0},_handleSpecialKey:function(e){var t=e.which;null===t&&(t=e.keyCode);var i=!1;switch(t){case 65:if(e.ctrlKey===!0||e.metaKey===!0){i=!0;var n=this.getCurrentRange();if(ice.dom.isBrowser("msie")===!0){var o=this.env.document.createTextNode(""),r=this.env.document.createTextNode("");this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,o):this.element.appendChild(o),this.element.appendChild(r),
n.setStart(o,0),n.setEnd(r,0)}else{n.setStart(n.getFirstSelectableChild(this.element),0);var s=n.getLastSelectableChild(this.element);n.setEnd(s,s.length)}this.selection.addRange(n)}break;case 66:if(e.ctrlKey===!0||e.metaKey===!0){i=!0;var n=this.getCurrentRange();this._moveRangeToValidTrackingPos(n,n.startContainer),this.insertBold(" ",n)}break;case 73:if(e.ctrlKey===!0||e.metaKey===!0){i=!0;var n=this.getCurrentRange();this._moveRangeToValidTrackingPos(n,n.startContainer),this.insertItalic(" ",n)}break;case 85:if(e.ctrlKey===!0||e.metaKey===!0){i=!0;var n=this.getCurrentRange();this._moveRangeToValidTrackingPos(n,n.startContainer),this.insertUnderline(" ",n)}}return i===!0?(ice.dom.preventDefault(e),!1):!0},mouseUp:function(e,t){return this.pluginsManager.fireClicked(e)?void this.pluginsManager.fireSelectionChanged(this.getCurrentRange()):!1},mouseDown:function(e,t){return this.pluginsManager.fireMouseDown(e)?void this.pluginsManager.fireCaretUpdated():!1}},i.ice=this.ice||{},i.ice.InlineChangeEditor=t}).call(this);